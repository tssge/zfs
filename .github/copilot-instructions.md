# OpenZFS Development Instructions

OpenZFS is an advanced file system and volume manager originally developed for Solaris and now maintained by the OpenZFS community. This repository contains the code for running OpenZFS on Linux and FreeBSD.

Always reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

## Working Effectively

### Essential Dependencies
Install required development packages:
```bash
sudo apt-get update
sudo apt-get install -y build-essential autoconf automake libtool git \
  libudev-dev uuid-dev libblkid-dev libattr1-dev libacl1-dev libtirpc-dev \
  python3-dev python3-setuptools python3-cffi libssl-dev zlib1g-dev \
  linux-headers-$(uname -r)
```

### Build Process
**IMPORTANT**: This repository may have build issues on certain branches. Always test the build process:

```bash
# Generate configure script - takes ~15 seconds
./autogen.sh

# Configure for userspace build - takes ~6-80 seconds. NEVER CANCEL.
./configure --with-config=user --enable-debug

# Attempt to build userspace components - may fail due to code issues
# Takes ~20-30 minutes when successful. NEVER CANCEL. Set timeout to 45+ minutes.
make -j$(nproc)
```

**CRITICAL BUILD NOTES:**
- **NEVER CANCEL** long-running commands - builds may take 30+ minutes
- Current branch may have compilation errors - this is not uncommon in development
- If build fails with compilation errors, the issue may be in the current code state
- Kernel module builds often fail due to version compatibility issues
- For reliable kernel builds, use the CI QEMU environment setup in `.github/workflows/scripts/`
- Use `--with-config=user` to build only userspace utilities when kernel modules fail
- **BUILD FAILURES ARE NORMAL** - focus on validation and testing that can be done without full compilation

### Alternative: Package Builds
For more reliable builds, create distribution packages:
```bash
# Debian/Ubuntu packages - takes ~45 minutes. NEVER CANCEL.
make deb-utils

# RPM packages (on RPM-based systems) - takes ~45 minutes. NEVER CANCEL.  
make rpm-utils
```

### Validation Workflow
Always run validation before committing (these work regardless of build status):
```bash
# Style and lint checking - takes ~2-5 minutes, works even with build failures
make shellcheck

# License compliance check - works even with build failures
make spdxcheck

# Manual page check (if mandoc installed) - works even with build failures  
make mancheck

# Run all style checks together (may fail on some checks due to missing tools)
make checkstyle
```

**Manual Validation Scenarios:**
These validation steps work even when the main build fails:
- Always verify `./autogen.sh && ./configure --with-config=user --enable-debug` completes without errors
- Test that `make shellcheck` passes without shell script errors
- Verify `make spdxcheck` passes for license compliance
- If working on shell scripts, test them individually with `shellcheck scriptname.sh`
- **DO NOT require a full successful build** - focus on configuration and validation tools

## Repository Structure & Navigation

### Key Directories
- `cmd/` - Command-line utilities (zfs, zpool, zdb, etc.)
- `lib/` - Libraries (libzfs, libzpool, etc.)
- `module/` - Kernel modules (SPL, ZFS kernel code)
- `include/` - Header files
- `tests/` - Test suites and test utilities
- `scripts/` - Build and maintenance scripts
- `man/` - Manual pages
- `contrib/` - Contributed utilities and integrations

### Important Files
- `META` - Version and build metadata
- `configure.ac` - Autotools configuration
- `Makefile.am` - Top-level build rules
- `autogen.sh` - Generate configure script
- `scripts/zfs-tests.sh` - Main test suite runner
- `scripts/zloop.sh` - Stress testing with ztest
- `scripts/common.sh` - Common utility functions

### Build Artifacts
Generated files you'll encounter:
- `configure` - Generated by autogen.sh
- `zfs_config.h` - Build configuration
- `include/zfs_gitrev.h` - Git revision info
- `*.la`, `*.lo` - Libtool library files

## Testing & Quality Assurance

### Test Suites
**NOTE:** Full test suites require ZFS kernel modules to be loaded.

```bash
# Basic test runner (requires ZFS installation)
./scripts/zfs-tests.sh -h    # Show help

# Stress testing (requires ZFS installation) 
./scripts/zloop.sh -h        # Show help
```

### Validation Commands
```bash
# Check shell script style
make shellcheck

# Check license headers
make spdxcheck  

# Check manual pages
make mancheck
```

## Common Development Tasks

### Code Style
- Follow C Style and Coding Standards for SunOS
- Use `.editorconfig` settings if your editor supports it
- Run `make checkstyle` before commits
- Shell scripts must pass shellcheck

### Debugging Builds
- Use `--enable-debug` configure option for development
- Check `config.log` for configure issues
- Build with `make V=1` for verbose output
- For kernel module issues, check `/var/log/kern.log` or `dmesg`

### Making Changes
- Work on userspace code in `cmd/` and `lib/` directories
- Kernel changes go in `module/` directory  
- Always run style checks before committing
- Test on multiple distributions if possible

## Build Timing Expectations

| Command | Expected Time | Timeout Setting |
|---------|---------------|----------------|
| `./autogen.sh` | ~15 seconds | 60 seconds |
| `./configure --with-config=user` | ~6 seconds | 300 seconds |
| `make -j$(nproc)` | ~20-30 minutes* | 45+ minutes |
| `make shellcheck` | ~2 seconds | 10 minutes |
| `make spdxcheck` | ~5 minutes | 10 minutes |
| `make deb-utils` | ~45 minutes | 90+ minutes |

*May fail with compilation errors - this is normal during development

**CRITICAL:** Never cancel builds that appear to hang. ZFS builds are CPU-intensive and can take significant time even on modern hardware.

## Known Limitations

### Build Issues
- **Current branch may have compilation errors** - this is normal during development
- Build failures in `module/zfs/dbuf.c` and similar files are code-level issues, not environment issues
- Focus on validation tools and configuration rather than requiring successful compilation
- When reporting build issues, distinguish between environmental problems and code bugs

### Kernel Module Builds
- May fail due to kernel version compatibility
- Require specific kernel headers matching running kernel
- CI uses QEMU VMs with controlled environments for reliable testing
- When kernel builds fail, use `--with-config=user` for userspace-only builds

### Environment Requirements  
- Requires development headers for kernel version
- Some features require specific kernel compile options
- Build may require significant disk space (>2GB)
- Memory requirements scale with parallel build jobs

### Testing Limitations
- Full test suites require ZFS kernel modules loaded
- Many tests require root privileges
- Tests may require multiple block devices
- Some tests can be destructive - only run in test environments

## Emergency Procedures

### Clean Build Environment
```bash
make clean
./autogen.sh
./configure --with-config=user --enable-debug  
make -j$(nproc)
```

### Reset to Known State
```bash
git clean -fdx
git reset --hard HEAD
```

### Common Build Failures
- **Missing dependencies**: Install packages listed in "Essential Dependencies"
- **Kernel module failures**: Use `--with-config=user` 
- **Configure failures**: Check `config.log`, install missing dependencies
- **Compilation errors in module/ directory**: These are often code issues, not environment issues
- **Style check failures**: Fix reported issues, rerun `make shellcheck` or `make spdxcheck`

## Common Development Workflows

### Working with Build Failures
When the main build fails (common in development branches):
1. Ensure configuration works: `./autogen.sh && ./configure --with-config=user --enable-debug`
2. Run validation tools: `make shellcheck && make spdxcheck`
3. Focus on specific areas you're modifying rather than full system build
4. Use CI logs from `.github/workflows/` to understand expected build behavior

### Code Changes
- **Shell scripts**: Modify and test with `shellcheck scriptname.sh`
- **Documentation**: Edit and verify with `make mancheck` 
- **C code**: May require full build, use validation tools when build fails
- **Build system**: Test with `./autogen.sh && ./configure` combinations

### Testing Changes
- **Script changes**: Run individual scripts to test functionality
- **Configuration changes**: Test different `./configure` options
- **Style changes**: Use `make shellcheck` and `make spdxcheck` for validation